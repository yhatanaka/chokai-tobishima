<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSI & OSM Map Switcher with Terrain</title>
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; background: #f0f0f0; }
        
        /* コントロールパネルのスタイル */
        #control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            width: 280px;
            max-width: 90%;
            z-index: 1000;
            transition: max-height 0.3s ease;
            overflow: hidden;
            max-height: 500px; /* 展開時の最大高さ */
        }
        
        #control-panel.collapsed {
            max-height: 40px; /* 畳んだ時の高さ */
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .toggle-btn {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
        }

        .control-group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .control-group:last-child { border-bottom: none; }
        .control-group h4 { margin: 0 0 8px 0; font-size: 14px; color: #333; }
        
        label { display: block; margin-bottom: 5px; font-size: 13px; cursor: pointer; }
        input[type="radio"], input[type="checkbox"] { margin-right: 8px; }
        input[type="range"] { width: 100%; margin-top: 5px; }

        /* 乗算モード用のCSSハック（地図キャンバス全体に乗算をかける） */
        .multiply-mode canvas.maplibregl-canvas {
            mix-blend-mode: multiply;
        }
        /* 乗算モード時は背景を白にして透過を防ぐ */
        .multiply-mode {
            background-color: #fff !important;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div id="control-panel">
    <div class="panel-header" onclick="togglePanel()">
        <span>地図切替・設定</span>
        <button class="toggle-btn" id="toggle-icon">▼</button>
    </div>
    
    <div id="panel-content">
        <div class="control-group">
            <h4>ベースマップ</h4>
            <label><input type="radio" name="basemap" value="gsi-vector" checked> 地理院 最適化ベクトル</label>
            <label><input type="radio" name="basemap" value="gsi-std"> 地理院 標準地図</label>
            <label><input type="radio" name="basemap" value="gsi-pale"> 地理院 淡色地図</label>
            <label><input type="radio" name="basemap" value="gsi-photo"> 地理院 写真地図</label>
            <label><input type="radio" name="basemap" value="osm-vector"> OSM ベクトル</label>
            <label><input type="radio" name="basemap" value="osm-raster"> OSM ラスタ</label>
        </div>

        <div class="control-group">
            <h4>陰影起伏図 (レイヤ)</h4>
            <label><input type="checkbox" id="hillshade-toggle"> 表示する</label>
            <label>不透明度: <span id="opacity-val">50%</span>
                <input type="range" id="hillshade-opacity" min="0" max="100" value="50">
            </label>
            <label title="地図全体の色を乗算合成し、地形を焼き込みます（暗くなります）">
                <input type="checkbox" id="multiply-mode"> 乗算モード (全体)
            </label>
        </div>

        <div class="control-group">
            <h4>3D地形 (DEM)</h4>
            <label><input type="checkbox" id="terrain-toggle"> 立体表示 (地形ON)</label>
            <div style="font-size:11px; color:#666; margin-top:4px;">※地理院標高タイルを使用</div>
        </div>
    </div>
</div>

<script>
    // --- 1. 国土地理院標高タイルをMapLibre形式(Terrain-RGB)に変換するプロトコル ---
    // 参考: 国土地理院のPNG標高タイルは独自の計算式が必要なため、クライアントサイドで変換します。
    maplibregl.addProtocol('gsidem', (params, callback) => {
        const image = new Image();
        image.crossOrigin = "anonymous";
        image.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = image.width;
            canvas.height = image.height;
            const context = canvas.getContext('2d');
            context.drawImage(image, 0, 0);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // 国土地理院の標高計算式: x = 2^16R + 2^8G + B
                // x < 2^23 の場合 h = x * 0.01
                // 無効値等はMapbox RGB形式の無効値や0にマッピング
                let h = 0;
                const x = (r << 16) + (g << 8) + b;
                
                if (x < 8388608) {
                    h = x * 0.01;
                } else if (x > 8388608) {
                    h = (x - 16777216) * 0.01;
                } else {
                    // 無効値
                    h = 0; 
                }
                
                // Mapbox Terrain-RGBへの変換: h = -10000 + ((R * 256 * 256 + G * 256 + B) * 0.1)
                // 逆算: (h + 10000) * 10 = R_m * 65536 + G_m * 256 + B_m
                const m = (h + 10000) * 10;
                
                const rm = Math.floor(m / 65536);
                const gm = Math.floor((m % 65536) / 256);
                const bm = Math.floor(m % 256);

                data[i] = rm;
                data[i + 1] = gm;
                data[i + 2] = bm;
                data[i + 3] = 255; // Alpha
            }
            context.putImageData(imageData, 0, 0);
            canvas.toBlob((blob) => callback(null, blob, null, null));
        };
        image.onerror = () => callback(new Error("Image load error"));
        // gsidem:// の後ろのURLを取得してリクエスト
        const url = params.url.replace('gsidem://', 'https://');
        image.src = url;
        return { cancel: () => {} };
    });

    // --- 2. 各種ソース・スタイルの定義 ---
    
    // 国土地理院ベクトルタイル（最適化）
    // 注意: 公式GitHubのstyle.jsonを利用
    const STYLE_GSI_VECTOR = 'https://gsi-cyberjapan.github.io/optimal_bvmap/style/std.json';
    
    // OpenStreetMap ベクトル（Bright-JA）
    const STYLE_OSM_VECTOR = 'https://tile.openstreetmap.jp/styles/osm-bright-ja/style.json';

    // ラスタ地図用の簡易スタイル生成関数
    function getRasterStyle(sourceKey, url, attribution) {
        return {
            version: 8,
            sources: {
                [sourceKey]: {
                    type: 'raster',
                    tiles: [url],
                    tileSize: 256,
                    attribution: attribution
                }
            },
            layers: [{
                id: 'base-raster',
                type: 'raster',
                source: sourceKey,
                minzoom: 0,
                maxzoom: 18
            }]
        };
    }

    const MAP_CONFIG = {
        'gsi-std': getRasterStyle('gsi-std', 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', '<a href="https://maps.gsi.go.jp/development/ichiran.html">地理院タイル</a>'),
        'gsi-pale': getRasterStyle('gsi-pale', 'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', '<a href="https://maps.gsi.go.jp/development/ichiran.html">地理院タイル</a>'),
        'gsi-photo': getRasterStyle('gsi-photo', 'https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg', '<a href="https://maps.gsi.go.jp/development/ichiran.html">地理院タイル</a>'),
        'osm-raster': getRasterStyle('osm-raster', 'https://tile.openstreetmap.org/{z}/{x}/{y}.png', '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors')
    };

    // --- 3. マップ初期化 ---
    const map = new maplibregl.Map({
        container: 'map',
        style: STYLE_GSI_VECTOR, // 初期表示: 国土地理院ベクトル
        center: [139.875, 39.077], // 初期中心点
        zoom: 12,
        pitch: 0,
        bearing: 0,
        attributionControl: true
    });

    // スケールコントロール
    map.addControl(new maplibregl.ScaleControl({ maxWidth: 200, unit: 'metric' }), 'bottom-left');

    // ナビゲーションコントロール
    map.addControl(new maplibregl.NavigationControl(), 'bottom-right');

    // --- 4. レイヤ管理ロジック ---

    // 共通の追加レイヤ（陰影起伏図とTerrain）を再適用する関数
    // スタイルを切り替えるとソースも消えるため、都度追加が必要
    function updateOverlayLayers() {
        // 1. 陰影起伏図ソース
        if (!map.getSource('gsi-hillshade-source')) {
            map.addSource('gsi-hillshade-source', {
                type: 'raster',
                tiles: ['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">地理院タイル(陰影起伏図)</a>'
            });
        }

        // 2. 陰影起伏図レイヤ
        if (!map.getLayer('gsi-hillshade-layer')) {
            map.addLayer({
                id: 'gsi-hillshade-layer',
                type: 'raster',
                source: 'gsi-hillshade-source',
                layout: {
                    visibility: document.getElementById('hillshade-toggle').checked ? 'visible' : 'none'
                },
                paint: {
                    'raster-opacity': parseInt(document.getElementById('hillshade-opacity').value) / 100
                }
            });
        }

        // 3. DEM (Terrain) ソース
        // プロトコル 'gsidem://' を使用して地理院PNGを変換
        if (!map.getSource('gsi-dem-source')) {
            map.addSource('gsi-dem-source', {
                type: 'raster-dem',
                tiles: ['gsidem://cyberjapandata.gsi.go.jp/xyz/dem_png/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">地理院タイル(標高)</a>',
                maxzoom: 14 // 標高タイルのMaxZoom
            });
        }

        // Terrainの適用状態を確認
        const terrainOn = document.getElementById('terrain-toggle').checked;
        if (terrainOn) {
            map.setTerrain({ source: 'gsi-dem-source', exaggeration: 1.5 }); // 少し強調
        } else {
            map.setTerrain(null);
        }
    }

    // マップのスタイル読み込み完了時にオーバーレイを復元
    map.on('style.load', () => {
        updateOverlayLayers();
    });

    // --- 5. UIイベントリスナー ---

    // ベースマップ切り替え
    document.querySelectorAll('input[name="basemap"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const val = e.target.value;
            if (val === 'gsi-vector') {
                map.setStyle(STYLE_GSI_VECTOR);
            } else if (val === 'osm-vector') {
                map.setStyle(STYLE_OSM_VECTOR);
            } else if (MAP_CONFIG[val]) {
                map.setStyle(MAP_CONFIG[val]);
            }
        });
    });

    // 陰影起伏図 トグル
    document.getElementById('hillshade-toggle').addEventListener('change', (e) => {
        if (map.getLayer('gsi-hillshade-layer')) {
            map.setLayoutProperty('gsi-hillshade-layer', 'visibility', e.target.checked ? 'visible' : 'none');
        }
    });

    // 陰影起伏図 不透明度
    document.getElementById('hillshade-opacity').addEventListener('input', (e) => {
        const opacity = parseInt(e.target.value) / 100;
        document.getElementById('opacity-val').innerText = e.target.value + '%';
        if (map.getLayer('gsi-hillshade-layer')) {
            map.setPaintProperty('gsi-hillshade-layer', 'raster-opacity', opacity);
        }
    });

    // 乗算モード切り替え (Canvas全体へのCSS Mix-Blend-Mode適用)
    document.getElementById('multiply-mode').addEventListener('change', (e) => {
        const mapDiv = document.getElementById('map');
        if (e.target.checked) {
            mapDiv.classList.add('multiply-mode');
        } else {
            mapDiv.classList.remove('multiply-mode');
        }
    });

    // Terrain (3D) トグル
    document.getElementById('terrain-toggle').addEventListener('change', (e) => {
        if (e.target.checked) {
            // ソースがあるか確認し、なければ追加（style変更直後などの対策）
            if (!map.getSource('gsi-dem-source')) updateOverlayLayers();
            map.setTerrain({ source: 'gsi-dem-source', exaggeration: 1.2 });
            map.easeTo({ pitch: 60, duration: 1000 }); // 少し傾ける
        } else {
            map.setTerrain(null);
            map.easeTo({ pitch: 0, duration: 1000 }); // 平面に戻す
        }
    });

    // パネル開閉
    function togglePanel() {
        const panel = document.getElementById('control-panel');
        const icon = document.getElementById('toggle-icon');
        panel.classList.toggle('collapsed');
        icon.innerText = panel.classList.contains('collapsed') ? '▲' : '▼';
    }
</script>

</body>
</html>