<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MapLibre GSI / OSM 切替サンプル</title>
  <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body,html,#map{height:100%;margin:0}
    #controls{position:absolute;top:8px;right:8px;background:#fff;padding:8px;border-radius:6px;box-shadow:0 1px 6px rgba(0,0,0,.2);font-size:13px}
    #controls.collapsed{height:28px;overflow:hidden}
    .layer-row{display:flex;align-items:center;gap:6px;margin:4px 0}
    #hillshadeImg{position:absolute;pointer-events:none;mix-blend-mode:normal;left:0;top:0;width:100%;height:100%;opacity:0;display:none}
  </style>
</head>
<body>
<div id="map"></div>
<div id="controls">
  <button id="toggle">▲</button>
  <div id="panel">
    <div><strong>ベース地図</strong></div>
    <div class="layer-row"><input type="radio" name="base" value="gsi_std" checked> GSI 標準</div>
    <div class="layer-row"><input type="radio" name="base" value="gsi_pale"> GSI 淡色</div>
    <div class="layer-row"><input type="radio" name="base" value="gsi_photo"> GSI 写真</div>
    <div class="layer-row"><input type="radio" name="base" value="gsi_opt"> GSI 最適化ベクタ</div>
    <div class="layer-row"><input type="radio" name="base" value="osm_raster"> OSM ラスタ (osm-bright-ja)</div>
    <div class="layer-row"><input type="radio" name="base" value="osm_vector"> OSM ベクタ</div>

    <hr/>
    <div><strong>陰影起伏図</strong></div>
    <div class="layer-row"><label>表示 <input id="hillToggle" type="checkbox"></label></div>
    <div class="layer-row">不透明度 <input id="hillOpacity" type="range" min="0" max="1" step="0.01" value="0.6"></div>
    <div class="layer-row">合成モード
      <select id="blendMode"><option value="normal">通常</option><option value="multiply">乗算</option></select>
    </div>

    <hr/>
    <div><strong>地形（DEM）</strong></div>
    <div class="layer-row">立体化 <input id="terrainToggle" type="checkbox"></div>
    <div class="layer-row">標高倍率 <input id="exag" type="range" min="0.5" max="2" step="0.01" value="1"></div>
  </div>
</div>

<script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
<script>
const map = new maplibregl.Map({
  container: 'map',
  style: {version:8,sources:{},layers:[]},
  center: [139.875,39.077],
  zoom: 9
});
map.addControl(new maplibregl.ScaleControl({position:'bottom-left'}));

// --- ソース定義（ラスタ） ---
const rasterSources = {
  gsi_std: {type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],tileSize:256},
  gsi_pale:{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png'],tileSize:256},
  gsi_photo:{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],tileSize:256},
  osm_raster:{type:'raster',tiles:['https://tile.openstreetmap.jp/styles/osm-bright-ja/{z}/{x}/{y}.png'],tileSize:256}
};
// GSI 最適化ベクトル（ベクタタイル）ソース（Mapbox Vector Tile）
const gsiVectorSource = {type:'vector',tiles:['https://gsi-cyberjapan.github.io/optimal_bvmap/tiles/{z}/{x}/{y}.pbf']}; // デモ配信例（リポジトリ参照）
// OSM ベクタ（OpenMapTiles）ソース
const osmVectorSource = {type:'vector',url:'https://tile.openstreetmap.jp/data/planet.json'}; // OpenMapTiles style endpoint 

// ラスタソースを追加して対応レイヤを作る
map.on('load',()=>{
  for(const k in rasterSources){ map.addSource(k, rasterSources[k]); map.addLayer({id:'base_'+k, type:'raster', source:k, layout:{visibility: k==='gsi_std' ? 'visible':'none'}}); }
  // GSI ベクタソース追加（サンプル）と簡易レイヤ（道路・水域などを表示する例）
  map.addSource('gsi_opt_vec', gsiVectorSource);
  map.addLayer({id:'gsi_opt_fill', type:'fill', source:'gsi_opt_vec', 'source-layer':'land', paint:{'fill-color':'#efe'} , layout:{visibility:'none'}});
  // OSM ベクタソース
  map.addSource('osm_vec', osmVectorSource);
  map.addLayer({id:'osm_vec_roads', type:'line', source:'osm_vec', 'source-layer':'transport', paint:{'line-color':'#d55', 'line-width':1.2}, layout:{visibility:'none'}});
  // 陰影起伏図ラスタ（オーバーレイ）
  map.addSource('hill', {type:'raster', tiles:['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'], tileSize:256});
  map.addLayer({id:'hill_layer', type:'raster', source:'hill', paint:{'raster-opacity':0.6}, layout:{visibility:'none'}});
  // DEM raster-dem ソース（terrain 用）
  map.addSource('dem', {type:'raster-dem', tiles:['https://cyberjapandata.gsi.go.jp/xyz/dem/{z}/{x}/{y}.png'], tileSize:256});
});

// UI 操作
document.querySelectorAll('input[name=base]').forEach(r=>{
  r.addEventListener('change', e=>{
    const v=e.target.value;
    // 全 base 非表示にして選択を表示
    ['gsi_std','gsi_pale','gsi_photo','osm_raster'].forEach(k=>map.setLayoutProperty('base_'+k,'visibility', k===v ? 'visible':'none'));
    // vector 切替
    map.setLayoutProperty('gsi_opt_fill','visibility', v==='gsi_opt' ? 'visible':'none');
    map.setLayoutProperty('osm_vec_roads','visibility', v==='osm_vector' ? 'visible':'none');
  });
});
document.getElementById('hillToggle').addEventListener('change',e=>{
  map.setLayoutProperty('hill_layer','visibility', e.target.checked ? 'visible':'none');
});
document.getElementById('hillOpacity').addEventListener('input',e=>{
  map.setPaintProperty('hill_layer','raster-opacity', parseFloat(e.target.value));
});
document.getElementById('blendMode').addEventListener('change',e=>{
  const mode=e.target.value;
  const canvas = map.getCanvas();
  // mix-blend-mode を使って乗算を実現（ブラウザ依存）
  canvas.style.mixBlendMode = mode==='multiply' ? 'multiply' : 'normal';
});
document.getElementById('terrainToggle').addEventListener('change',e=>{
  if(e.target.checked){
    map.setTerrain({source:'dem',exaggeration:parseFloat(document.getElementById('exag').value)});
  } else { map.setTerrain(null); }
});
document.getElementById('exag').addEventListener('input',e=>{
  const v=parseFloat(e.target.value);
  if(map.getTerrain()) map.setTerrain({source:'dem',exaggeration:v});
});
// 折りたたみ
const ctrl=document.getElementById('controls'), btn=document.getElementById('toggle');
btn.addEventListener('click',()=>{ ctrl.classList.toggle('collapsed'); btn.textContent = ctrl.classList.contains('collapsed') ? '▼':'▲'; });
</script>
</body>
</html>
