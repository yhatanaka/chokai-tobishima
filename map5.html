<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GSI / OSM 切替マップ（MapLibre）</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://cdn.jsdelivr.net/npm/maplibre-gl@5.15.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body,html,#map { height:100%; margin:0; }
    .panel { position:absolute; top:8px; right:8px; background:#fffccf; padding:8px; border-radius:6px; font-size:13px; box-shadow:0 1px 6px rgba(0,0,0,0.3); }
    .panel .fold { cursor:pointer; font-weight:bold; }
    .controls { margin-top:6px; }
    .small { font-size:12px; }
  </style>
</head>
<body>
<div id="map"></div>
<div class="panel" id="panel">
  <div class="fold" id="foldBtn">▲ 地図切替</div>
  <div id="controls" class="controls">
    <div><select id="basemap">
      <option value="gsi-opt">GSI 最適化ベクトル（試験）</option>
      <option value="gsi-std">GSI 標準地図</option>
      <option value="gsi-pale">GSI 淡色地図</option>
      <option value="gsi-photo">GSI 写真地図</option>
      <option value="osm-raster">OSM ラスタ (osm-bright-ja)</option>
      <option value="osm-vector">OSM ベクタースタイル</option>
    </select></div>

    <div class="small" style="margin-top:6px;">
      <label>陰影不透明度 <input id="hillOpacity" type="range" min="0" max="1" step="0.01" value="0.6"></label>
      <div><label><input type="radio" name="blend" value="normal" checked> 通常</label>
      <label><input type="radio" name="blend" value="multiply"> 乗算</label></div>
    </div>

    <div style="margin-top:6px;">
      <label>標高強調 <input id="exag" type="range" min="0.1" max="2" step="0.01" value="1"></label>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@5.15.0/dist/maplibre-gl.min.js"></script>
<script>
const map = new maplibregl.Map({
  container: 'map',
  style: {version:8,sources:{},layers:[]}, // 空スタイルで初期化
  center: [139.875,39.077],
  zoom: 6,
  pitch: 45,
  bearing: -17
});
map.addControl(new maplibregl.ScaleControl({position:'bottom-left'}));

// --- ソース定義（GSI ラスター・陰影・DEM、OSM ラスタ、OSM ベクタースタイルは外部styleをfetchして適用） ---
const sources = {
  'gsi-std': { type:'raster', tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'], tileSize:256, attribution:'国土地理院' },
  'gsi-pale': { type:'raster', tiles:['https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png'], tileSize:256, attribution:'国土地理院' },
  'gsi-photo': { type:'raster', tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'], tileSize:256, attribution:'国土地理院' },
  'osm-raster': { type:'raster', tiles:['https://tile.openstreetmap.jp/styles/osm-bright-ja/{z}/{x}/{y}.png'], tileSize:256, attribution:'© OpenStreetMap contributors' },
  'gsi-hill': { type:'raster', tiles:['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'], tileSize:256, attribution:'国土地理院' },
  // DEM: MapLibre expects PNG-encoded raster-dem; GSI の標高タイルPNG版は /xyz/dem/{z}/{x}/{y}.png（仕様参照）
  'gsi-dem': { type:'raster-dem', tiles:['https://cyberjapandata.gsi.go.jp/xyz/dem/{z}/{x}/{y}.png'], tileSize:256, attribution:'国土地理院' }
};

// ベースレイヤを追加する関数（ラスタ系）
function addRasterBase(id, sourceKey) {
  if (map.getLayer('base')) map.removeLayer('base');
  if (!map.getSource('base-src')) {
    map.addSource('base-src', sources[sourceKey]);
  } else {
    map.removeSource('base-src');
    map.addSource('base-src', sources[sourceKey]);
  }
  map.addLayer({ id:'base', type:'raster', source:'base-src', paint:{'raster-opacity':1} }, null);
}

// 陰影レイヤ
function addHillshade() {
  if (map.getLayer('hill')) map.removeLayer('hill');
  if (map.getSource('hill-src')) map.removeSource('hill-src');
  map.addSource('hill-src', sources['gsi-hill']);
  map.addLayer({ id:'hill', type:'raster', source:'hill-src', paint:{'raster-opacity':0.6} }, 'base');
}
map.on('load', () => {
  // 初期ベース
  addRasterBase('gsi-std','gsi-std');
  addHillshade();

  // terrain 登録（DEM）
  if (!map.getSource('gsi-dem')) map.addSource('gsi-dem', sources['gsi-dem']);
  // sea を平面にするための補正（説明参照）: 海域は標高タイルで欠損値や特定色が使われるため、クライアント側で海域ポリゴンを取得して高さを0にする補正レイヤを追加する手法を採る
  map.setTerrain({ source: 'gsi-dem', exaggeration: 1.0 });
});

// UI 挙動
document.getElementById('basemap').addEventListener('change', (e)=>{
  const v = e.target.value;
  if (v === 'osm-vector') {
    // OSM ベクタースタイルを外部 style.json から取得して適用（CORS 必須）
    fetch('https://tile.openstreetmap.jp/styles/osm-bright-ja/style.json').then(r=>r.json()).then(style=>{
      // style の sources 内の tiles が相対の場合は補正が必要。ここでは外部 style をそのまま適用する例。
      map.setStyle(style);
      // 再度 hillshade と terrain を追加するために load イベントで処理する必要あり（省略）
    }).catch(err=>{ alert('OSM vector style の読み込みに失敗しました: '+err); });
  } else {
    // raster ベースに戻す（空スタイルに戻してからラスタを追加）
    map.setStyle({version:8,sources:{},layers:[]});
    map.once('styledata', ()=> {
      if (v==='gsi-opt') {
        // 最適化ベクトルタイル（試験公開）については GitHub のデモスタイルを参照してください（CORS/ホスティング要件あり）
        // ここでは代替として GSI 標準を表示
        addRasterBase('gsi-std','gsi-std');
      } else if (v==='gsi-std') addRasterBase('gsi-std','gsi-std');
      else if (v==='gsi-pale') addRasterBase('gsi-pale','gsi-pale');
      else if (v==='gsi-photo') addRasterBase('gsi-photo','gsi-photo');
      else if (v==='osm-raster') addRasterBase('osm-raster','osm-raster');
      addHillshade();
      // 再登録：DEM source と terrain
      if (!map.getSource('gsi-dem')) map.addSource('gsi-dem', sources['gsi-dem']);
      map.setTerrain({ source: 'gsi-dem', exaggeration: parseFloat(document.getElementById('exag').value) });
    });
  }
});

// 陰影不透明度と合成モード
document.getElementById('hillOpacity').addEventListener('input', (e)=>{
  const v = parseFloat(e.target.value);
  if (map.getLayer('hill')) map.setPaintProperty('hill','raster-opacity', v);
});
document.querySelectorAll('input[name="blend"]').forEach(r=>{
  r.addEventListener('change', ()=> {
    const mode = document.querySelector('input[name="blend"]:checked').value;
    // Canvas 全体の合成モードを切替（注意：ブラウザ互換と副作用あり）
    map.getCanvas().style.mixBlendMode = (mode==='multiply') ? 'multiply' : 'normal';
  });
});

// 標高強調スライダー
document.getElementById('exag').addEventListener('input', (e)=>{
  const val = parseFloat(e.target.value);
  // MapLibre の terrain exaggeration を更新
  map.setTerrain({ source:'gsi-dem', exaggeration: val });
});

// 折りたたみ
document.getElementById('foldBtn').addEventListener('click', ()=>{
  const c = document.getElementById('controls');
  if (c.style.display === 'none') { c.style.display='block'; document.getElementById('foldBtn').textContent='▲ 地図切替'; }
  else { c.style.display='none'; document.getElementById('foldBtn').textContent='▼ 地図切替'; }
});
</script>
</body>
</html>
