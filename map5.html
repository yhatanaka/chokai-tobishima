<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MapLibre GSI / OSM 切替デモ</title>
<link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
<style>
  body,html,#map{height:100%;margin:0;padding:0}
  #map{position:relative}
  .panel{position:absolute;top:8px;right:8px;background:#fff;border-radius:6px;padding:8px;box-shadow:0 1px 6px rgba(0,0,0,.2);font-size:13px;z-index:2}
  .panel .fold{cursor:pointer;color:#0078d4;margin-bottom:6px}
  .controls{display:block}
  .row{margin:6px 0}
  label{display:block;font-size:12px;margin-bottom:4px}
  input[type=range]{width:180px}
  .scale{position:absolute;left:8px;bottom:8px;background:#fff;padding:4px;border-radius:4px;box-shadow:0 1px 4px rgba(0,0,0,.2);font-size:12px}
</style>
</head>
<body>
<div id="map"></div>

<div class="panel" id="panel">
  <div class="fold" id="fold">▲ レイヤ操作</div>
  <div class="controls" id="controls">
    <div class="row"><strong>ベースマップ</strong>
      <select id="basemap">
        <option value="gsi_std">国土地理院 標準地図</option>
        <option value="gsi_pale">国土地理院 淡色地図</option>
        <option value="gsi_photo">国土地理院 写真地図</option>
        <option value="gsi_optvec">国土地理院 最適化ベクトル（簡易）</option>
        <option value="osm_raster">OpenStreetMap ラスタ</option>
        <option value="osm_bright">OSM Bright JA（ラスタ）</option>
      </select>
    </div>

    <div class="row"><strong>陰影起伏図</strong>
      <label><input type="checkbox" id="hill_on" checked> 表示</label>
      <label>不透明度 <input id="hill_opacity" type="range" min="0" max="1" step="0.01" value="0.6"></label>
      <label>合成モード
        <select id="hill_blend">
          <option value="normal">通常</option>
          <option value="multiply">乗算</option>
        </select>
      </label>
    </div>

    <div class="row"><strong>地形（terrain）</strong>
      <label><input type="checkbox" id="terrain_on"> 3D地形を有効</label>
      <label>強調倍率 <input id="exaggeration" type="range" min="0.1" max="2" step="0.01" value="1"></label>
    </div>
  </div>
</div>

<div class="scale" id="scale"></div>

<script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
<script>
const map = new maplibregl.Map({
  container: 'map',
  style: {version:8,sources:{},layers:[]},
  center: [139.875,39.077],
  zoom: 10,
  pitch: 0,
  bearing: 0,
  maxPitch:85
});

// スケール表示
const scaleEl = document.getElementById('scale');
const scale = new maplibregl.ScaleControl({maxWidth:200,unit:'metric'});
map.addControl(scale,'bottom-left');

// ベースマップ用ソース／レイヤを作る（ラスタ中心）
function addBaseLayers(){
  // GSI 標準
  map.addSource('gsi_std_src',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],tileSize:256,attribution:'国土地理院'});
  map.addLayer({id:'gsi_std',type:'raster',source:'gsi_std_src',layout:{visibility:'visible'}});
  // 淡色
  map.addSource('gsi_pale_src',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png'],tileSize:256});
  map.addLayer({id:'gsi_pale',type:'raster',source:'gsi_pale_src',layout:{visibility:'none'}});
  // 写真
  map.addSource('gsi_photo_src',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],tileSize:256});
  map.addLayer({id:'gsi_photo',type:'raster',source:'gsi_photo_src',layout:{visibility:'none'}});
  // OSM ラスタ
  map.addSource('osm_raster_src',{type:'raster',tiles:['https://tile.openstreetmap.jp/{z}/{x}/{y}.png'],tileSize:256,attribution:'© OpenStreetMap contributors'});
  map.addLayer({id:'osm_raster',type:'raster',source:'osm_raster_src',layout:{visibility:'none'}});
  // OSM Bright JA (ラスタ版)
  map.addSource('osm_bright_src',{type:'raster',tiles:['https://tile.openstreetmap.jp/styles/osm-bright-ja/{z}/{x}/{y}.png'],tileSize:256});
  map.addLayer({id:'osm_bright',type:'raster',source:'osm_bright_src',layout:{visibility:'none'}});
  // 国土地理院 最適化ベクトルタイル（簡易表示：ベクターソース＋簡易レイヤ）
  map.addSource('gsi_optvec_src',{type:'vector',tiles:['https://cyberjapandata.gsi.go.jp/xyz/optimal_bvmap-v1/{z}/{x}/{y}.pbf'],minzoom:4,maxzoom:16});
  // 簡易に「land」相当を塗る（タイルの実レイヤ名は変わる可能性あり）
  map.addLayer({id:'gsi_optvec_land',type:'fill',source:'gsi_optvec_src','source-layer':'land',paint:{'fill-color':'#efe8d6'},layout:{visibility:'none'}});
  map.addLayer({id:'gsi_optvec_road',type:'line',source:'gsi_optvec_src','source-layer':'road',paint:{'line-color':'#c66','line-width':1},layout:{visibility:'none'}});
}
map.on('load',()=>{
  addBaseLayers();

  // 陰影起伏図レイヤ（上に重ねる）
  map.addSource('gsi_hill',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'],tileSize:256});
  map.addLayer({id:'gsi_hill_layer',type:'raster',source:'gsi_hill',paint:{'raster-opacity':0.6},layout:{visibility:'visible'}});
});

// UI 操作
document.getElementById('basemap').addEventListener('change',e=>{
  const v=e.target.value;
  const ids=['gsi_std','gsi_pale','gsi_photo','gsi_optvec_land','gsi_optvec_road','osm_raster','osm_bright'];
  ids.forEach(id=>{ if(map.getLayer(id)) map.setLayoutProperty(id,'visibility','none'); });
  if(v==='gsi_optvec'){ ['gsi_optvec_land','gsi_optvec_road'].forEach(id=>map.setLayoutProperty(id,'visibility','visible')); }
  else map.setLayoutProperty(v,'visibility','visible');
});

// 陰影コントロール
document.getElementById('hill_opacity').addEventListener('input',e=>{
  const v=parseFloat(e.target.value); if(map.getLayer('gsi_hill_layer')) map.setPaintProperty('gsi_hill_layer','raster-opacity',v);
});
document.getElementById('hill_on').addEventListener('change',e=>{
  map.setLayoutProperty('gsi_hill_layer','visibility', e.target.checked ? 'visible' : 'none');
});
document.getElementById('hill_blend').addEventListener('change',e=>{
  const mode=e.target.value;
  // MapLibre は直接 blend mode をレイヤで指定できないため、canvas フィルタで代替
  const canvas = map.getCanvas();
  canvas.style.mixBlendMode = (mode==='multiply') ? 'multiply' : 'normal';
});

// 折りたたみ
document.getElementById('fold').addEventListener('click',()=>{
  const c=document.getElementById('controls');
  c.style.display = c.style.display==='none' ? 'block' : 'none';
  document.getElementById('fold').textContent = c.style.display==='none' ? '▼ レイヤ操作' : '▲ レイヤ操作';
});

// --- DEM を MapLibre terrain 用に変換するプロトコル（国土地理院 DEM PNG -> TerrainRGB） ---
// 国土地理院の DEM PNG エンコード仕様に合わせて変換する（クライアント変換）
// 参考: 国土地理院 標高タイル仕様、MapLibre DEM 変換手法（addProtocol）を利用。
maplibregl.addProtocol('gsidem', (params, callback) => {
  const url = params.url.replace('gsidem://','');
  const img = new Image(); img.crossOrigin = '';
  img.onload = () => {
    const w=img.width, h=img.height;
    const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
    const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0);
    const id=ctx.getImageData(0,0,w,h);
    const d=id.data;
    // GSI DEM -> height (m): h = (R*256*256 + G*256 + B) * 0.01 ; special (128,0,0) = no-data ; if R>=128 subtract 2^24
    // TerrainRGB encoding: height' = -10000 + value*0.1  => we need to map GSI height to TerrainRGB bytes
    for(let i=0;i<d.length;i+=4){
      const R=d[i], G=d[i+1], B=d[i+2];
      if(R===128 && G===0 && B===0){
        // no-data -> set to 0 height (encode as terrain value for -10000)
        d[i]=0; d[i+1]=0; d[i+2]=0;
        continue;
      }
      let x = R*65536 + G*256 + B;
      if(R>=128) x = x - 16777216;
      let hgt = x * 0.01; // meters (GSI)
      // convert to TerrainRGB value: terrainHeight = -10000 + ((R_t*256*256 + G_t*256 + B_t) * 0.1)
      // so we need value = (hgt + 10000) / 0.1
      let val = Math.round((hgt + 10000) / 0.1);
      if(val<0) val=0; if(val>16777215) val=16777215;
      const Rt = (val >> 16) & 255;
      const Gt = (val >> 8) & 255;
      const Bt = val & 255;
      d[i]=Rt; d[i+1]=Gt; d[i+2]=Bt;
    }
    ctx.putImageData(id,0,0);
    canvas.toBlob(blob => {
      blob.arrayBuffer().then(buf => callback(null, buf, null, null));
    }, 'image/png');
  };
  img.onerror = () => callback(new Error('DEM load error'));
  img.src = url;
  return {cancel:()=>{}};
});

// terrain ソースを追加（gsidem プロトコルを使う）
function enableTerrain(exag){
  if(map.getSource('gsi_dem')) return;
  map.addSource('gsi_dem',{type:'raster-dem',tiles:['gsidem://https://cyberjapandata.gsi.go.jp/xyz/dem_png/{z}/{x}/{y}.png'],tileSize:256,encoding:'mapbox'});
  map.setTerrain({source:'gsi_dem',exaggeration:exag});
}
function disableTerrain(){
  try{ map.setTerrain(null); if(map.getSource('gsi_dem')) map.removeSource('gsi_dem'); }catch(e){}
}

// terrain UI
document.getElementById('terrain_on').addEventListener('change',e=>{
  const on=e.target.checked;
  if(on) enableTerrain(parseFloat(document.getElementById('exaggeration').value));
  else disableTerrain();
});
document.getElementById('exaggeration').addEventListener('input',e=>{
  const v=parseFloat(e.target.value);
  if(map.getTerrain()) map.setTerrain({source:'gsi_dem',exaggeration:v});
});
</script>
</body>
</html>
