<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSI Vector & Raster Switcher</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* コントロールパネルのスタイル */
        #menu {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 250px;
        }
        .control-group { margin-bottom: 15px; }
        .control-group h4 { margin: 0 0 5px 0; font-size: 14px; }
        .layer-option { display: block; margin-bottom: 5px; cursor: pointer; }
        input[type=range] { width: 100%; }
        label { font-size: 13px; }
    </style>
</head>
<body>

<div id="menu">
    <div class="control-group">
        <h4>ベース地図</h4>
        <label class="layer-option">
            <input type="radio" name="basemap" value="vector" checked> 地理院 ベクトル (標準)
        </label>
        <label class="layer-option">
            <input type="radio" name="basemap" value="std"> 地理院 標準地図 (ラスター)
        </label>
        <label class="layer-option">
            <input type="radio" name="basemap" value="photo"> 地理院 写真
        </label>
        <label class="layer-option">
            <input type="radio" name="basemap" value="osm"> OpenStreetMap
        </label>
    </div>

    <div class="control-group">
        <h4>陰影起伏図 (重ね合わせ)</h4>
        <label class="layer-option">
            <input type="checkbox" id="hillshade-toggle" checked> 表示する
        </label>
        
        <label>不透明度: <span id="opacity-val">50%</span></label>
        <input type="range" id="hillshade-opacity" min="0" max="100" value="50">
        
        <label class="layer-option" style="margin-top: 8px;">
            <input type="checkbox" id="blend-mode-toggle"> 乗算モード (擬似)
            <div style="font-size: 10px; color: #666; margin-top:2px;">※WebGLの仕様上、完全な乗算ではなくコントラスト強調で再現します。</div>
        </label>
    </div>
</div>

<div id="map"></div>

<script>
    // --- 1. 各地図の定義 ---
    
    // 国土地理院 ベクトルタイル (GitHub公開のスタイル定義を使用)
    const styleVector = 'https://gsi-cyberjapan.github.io/gsivectortile-mapbox-gl-js/std.json';

    // 国土地理院 標準地図 (ラスター)
    const styleStd = {
        version: 8,
        sources: {
            'gsi-std': {
                type: 'raster',
                tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">国土地理院</a>'
            }
        },
        layers: [{
            id: 'gsi-std-layer',
            type: 'raster',
            source: 'gsi-std',
            minzoom: 0,
            maxzoom: 18
        }]
    };

    // 国土地理院 写真 (ラスター)
    const stylePhoto = {
        version: 8,
        sources: {
            'gsi-photo': {
                type: 'raster',
                tiles: ['https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg'],
                tileSize: 256,
                attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">国土地理院</a>'
            }
        },
        layers: [{
            id: 'gsi-photo-layer',
            type: 'raster',
            source: 'gsi-photo',
            minzoom: 0,
            maxzoom: 18
        }]
    };

    // OpenStreetMap
    const styleOsm = {
        version: 8,
        sources: {
            'osm': {
                type: 'raster',
                tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }
        },
        layers: [{
            id: 'osm-layer',
            type: 'raster',
            source: 'osm',
            minzoom: 0,
            maxzoom: 19
        }]
    };

    // --- 2. マップの初期化 ---

    const map = new maplibregl.Map({
        container: 'map',
        style: styleVector, // 初期表示はベクトル
        center: [138.7274, 35.3606], // 富士山周辺
        zoom: 12,
        hash: true
    });

    // --- 3. 陰影起伏図の管理ロジック ---

    // 陰影起伏図のソース定義
    const hillshadeSourceId = 'gsi-hillshade';
    const hillshadeLayerId = 'gsi-hillshade-layer';
    
    const hillshadeSource = {
        type: 'raster',
        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'],
        tileSize: 256,
        attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">国土地理院</a>'
    };

    // レイヤーを追加/更新する関数
    function updateHillshadeLayer() {
        const isVisible = document.getElementById('hillshade-toggle').checked;
        const opacity = parseInt(document.getElementById('hillshade-opacity').value) / 100;
        const isMultiply = document.getElementById('blend-mode-toggle').checked;

        // まだソースがない場合は追加 (スタイル切り替え直後など)
        if (!map.getSource(hillshadeSourceId)) {
            map.addSource(hillshadeSourceId, hillshadeSource);
        }

        // まだレイヤーがない場合は追加
        if (!map.getLayer(hillshadeLayerId)) {
            map.addLayer({
                id: hillshadeLayerId,
                type: 'raster',
                source: hillshadeSourceId,
                paint: {
                    'raster-opacity': opacity,
                    'raster-fade-duration': 0
                }
            });
        }

        // 表示・非表示の設定
        map.setLayoutProperty(hillshadeLayerId, 'visibility', isVisible ? 'visible' : 'none');
        
        // 不透明度の設定
        map.setPaintProperty(hillshadeLayerId, 'raster-opacity', opacity);

        // "擬似" 乗算モードの処理
        // WebGLレイヤーにはmix-blend-modeが効かないため、コントラストや彩度で調整
        if (isMultiply) {
            // 乗算っぽく見せるために少しコントラストを上げ、明るさを落とす（黒を強調）
            map.setPaintProperty(hillshadeLayerId, 'raster-contrast', 0.5); 
            map.setPaintProperty(hillshadeLayerId, 'raster-brightness-min', 0); 
            map.setPaintProperty(hillshadeLayerId, 'raster-brightness-max', 0.6); // 白をグレーに落とす
        } else {
            // 通常モード
            map.setPaintProperty(hillshadeLayerId, 'raster-contrast', 0);
            map.setPaintProperty(hillshadeLayerId, 'raster-brightness-min', 0);
            map.setPaintProperty(hillshadeLayerId, 'raster-brightness-max', 1);
        }
    }

    // スタイルが読み込まれたとき（ベース地図切り替え時）に必ず陰影起伏図を再適用する
    map.on('styledata', () => {
        // スタイルロード完了直後にレイヤーが消えているので再追加を試みる
        updateHillshadeLayer();
    });

    // --- 4. UI操作イベント ---

    // ベース地図の切り替え
    const radios = document.getElementsByName('basemap');
    for (const radio of radios) {
        radio.onclick = (layer) => {
            const val = layer.target.value;
            if (val === 'vector') map.setStyle(styleVector);
            else if (val === 'std') map.setStyle(styleStd);
            else if (val === 'photo') map.setStyle(stylePhoto);
            else if (val === 'osm') map.setStyle(styleOsm);
        };
    }

    // 陰影起伏図コントロール
    document.getElementById('hillshade-toggle').addEventListener('change', updateHillshadeLayer);
    
    document.getElementById('hillshade-opacity').addEventListener('input', (e) => {
        document.getElementById('opacity-val').innerText = e.target.value + '%';
        updateHillshadeLayer();
    });

    document.getElementById('blend-mode-toggle').addEventListener('change', updateHillshadeLayer);

    // コントロールの追加 (ズームなど)
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

</script>

</body>
</html>