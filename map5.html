<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapLibre GSI & OSM Multi-Map</title>
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* コントロールパネルのスタイル */
        #control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 260px;
            max-height: 90vh;
            overflow-y: auto;
            transition: all 0.3s ease;
            font-size: 14px;
            z-index: 1000;
        }

        /* 折りたたみ状態 */
        #control-panel.collapsed {
            width: 40px;
            height: 40px;
            overflow: hidden;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* 折りたたみトグルボタン */
        #toggle-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            background: none;
            border: none;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
        }

        #panel-content {
            display: block;
        }
        
        #control-panel.collapsed #panel-content {
            display: none;
        }

        /* アイコン（折りたたみ時） */
        .menu-icon::before {
            content: "≡";
            font-size: 24px;
        }

        h3 { margin: 0 0 10px 0; font-size: 16px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .section { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; cursor: pointer; }
        input[type="radio"], input[type="checkbox"] { margin-right: 8px; }
        .slider-container { display: flex; align-items: center; justify-content: space-between; margin-top: 5px; }
        input[type="range"] { width: 100%; margin: 0 5px; }
        .val-display { font-size: 12px; color: #666; width: 30px; text-align: right; }
        
        .note { font-size: 11px; color: #666; margin-top: 4px; line-height: 1.2; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="control-panel">
    <button id="toggle-btn" title="パネル切り替え">−</button>
    <div id="menu-icon-placeholder" class="menu-icon" style="display:none;"></div>
    
    <div id="panel-content">
        <h3>地図切り替え</h3>
        <div class="section" id="basemaps">
            </div>

        <h3>レイヤ設定</h3>
        <div class="section">
            <label>
                <input type="checkbox" id="hillshade-toggle">
                国土地理院 陰影起伏図
            </label>
            <div class="slider-container">
                <span>薄</span>
                <input type="range" id="hillshade-opacity" min="0" max="1" step="0.1" value="0.7">
                <span>濃</span>
            </div>
            <label style="margin-top:5px; color:#555;">
                <input type="checkbox" id="hillshade-multiply">
                乗算モード (擬似)
            </label>
            <p class="note">※MapLibreの仕様上、完全な乗算合成は非対応のため、濃さを調整して再現します。</p>
        </div>

        <h3>3D地形 (Terrain)</h3>
        <div class="section">
            <label>
                <input type="checkbox" id="terrain-toggle">
                地形を立体化 (GSIデータ)
            </label>
            <label style="font-size:12px; margin-top:5px;">高さ強調: <span id="exaggeration-val">1.0</span>倍</label>
            <div class="slider-container">
                <input type="range" id="terrain-exaggeration" min="1" max="3" step="0.1" value="1.0">
            </div>
            <p class="note">情報源: 産総研シームレス標高タイル(国土地理院基盤地図情報利用)</p>
        </div>
    </div>
</div>

<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>

<script>
    // --- 地図定義 ---
    const mapStyles = {
        'gsi-vector': {
            name: '地理院 最適化ベクトル',
            // 国土地理院ベクトルタイルの公式GitHub提供スタイル
            style: 'https://gsi-cyberjapan.github.io/gsivectortile-mapbox-gl-js/std.json'
        },
        'gsi-std': {
            name: '地理院 標準地図',
            style: {
                version: 8,
                sources: {
                    'gsi-std': {
                        type: 'raster',
                        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">国土地理院</a>'
                    }
                },
                layers: [{
                    id: 'gsi-std-layer',
                    type: 'raster',
                    source: 'gsi-std',
                    minzoom: 0,
                    maxzoom: 18
                }]
            }
        },
        'gsi-pale': {
            name: '地理院 淡色地図',
            style: {
                version: 8,
                sources: {
                    'gsi-pale': {
                        type: 'raster',
                        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">国土地理院</a>'
                    }
                },
                layers: [{
                    id: 'gsi-pale-layer',
                    type: 'raster',
                    source: 'gsi-pale',
                    minzoom: 0,
                    maxzoom: 18
                }]
            }
        },
        'gsi-photo': {
            name: '地理院 写真',
            style: {
                version: 8,
                sources: {
                    'gsi-photo': {
                        type: 'raster',
                        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg'],
                        tileSize: 256,
                        attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">国土地理院</a>'
                    }
                },
                layers: [{
                    id: 'gsi-photo-layer',
                    type: 'raster',
                    source: 'gsi-photo',
                    minzoom: 0,
                    maxzoom: 18
                }]
            }
        },
        'osm-raster': {
            name: 'OpenStreetMap (Raster)',
            style: {
                version: 8,
                sources: {
                    'osm-raster': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }
                },
                layers: [{
                    id: 'osm-raster-layer',
                    type: 'raster',
                    source: 'osm-raster',
                    minzoom: 0,
                    maxzoom: 19
                }]
            }
        },
        'osm-vector': {
            name: 'OpenStreetMap (Vector)',
            style: 'https://tile.openstreetmap.jp/styles/osm-bright-ja/style.json'
        }
    };

    // 初期設定
    const initialCenter = [139.875, 39.077]; // 山形県遊佐町付近
    const initialZoom = 12;
    let currentStyleId = 'gsi-vector';

    // マップ初期化
    const map = new maplibregl.Map({
        container: 'map',
        style: mapStyles[currentStyleId].style,
        center: initialCenter,
        zoom: initialZoom,
        pitch: 0,
        bearing: 0,
        hash: true
    });

    // スケールコントロール
    map.addControl(new maplibregl.ScaleControl({ maxWidth: 200, unit: 'metric' }), 'bottom-left');
    // ナビゲーションコントロール（ズーム・回転）
    map.addControl(new maplibregl.NavigationControl(), 'bottom-right');

    // --- UI生成 ---
    const basemapContainer = document.getElementById('basemaps');
    Object.keys(mapStyles).forEach(key => {
        const div = document.createElement('div');
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'basemap';
        radio.value = key;
        radio.checked = (key === currentStyleId);
        radio.onchange = () => changeBaseMap(key);
        
        const label = document.createElement('label');
        label.appendChild(radio);
        label.appendChild(document.createTextNode(mapStyles[key].name));
        div.appendChild(label);
        basemapContainer.appendChild(div);
    });

    // --- ロジック ---

    // 1. ベースマップ切り替え処理
    function changeBaseMap(styleId) {
        currentStyleId = styleId;
        const styleConfig = mapStyles[styleId].style;
        
        // スタイルをセット
        map.setStyle(styleConfig);

        // スタイルが切り替わると追加したソース・レイヤが消えるため、再ロード後に復元するイベントを設定
        map.once('style.load', () => {
            restoreOverlays();
        });
    }

    // 2. オーバーレイ（陰影図・地形）の復元と管理
    function restoreOverlays() {
        updateHillshade();
        updateTerrain();
    }

    // --- 陰影起伏図の処理 ---
    const HILLSHADE_SOURCE_ID = 'gsi-hillshade-source';
    const HILLSHADE_LAYER_ID = 'gsi-hillshade-layer';

    function updateHillshade() {
        const isChecked = document.getElementById('hillshade-toggle').checked;
        const opacity = parseFloat(document.getElementById('hillshade-opacity').value);
        // MapLibreではRasterLayerに乗算モードはないため、乗算チェック時は不透明度を少し上げて擬似的に強調するか、
        // 単にユーザーの意図として管理する（ここでは透過率の微調整のみとする）
        
        if (!isChecked) {
            if (map.getLayer(HILLSHADE_LAYER_ID)) {
                map.removeLayer(HILLSHADE_LAYER_ID);
            }
            if (map.getSource(HILLSHADE_SOURCE_ID)) {
                map.removeSource(HILLSHADE_SOURCE_ID);
            }
            return;
        }

        // ソースがなければ追加
        if (!map.getSource(HILLSHADE_SOURCE_ID)) {
            map.addSource(HILLSHADE_SOURCE_ID, {
                type: 'raster',
                tiles: ['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: '国土地理院'
            });
        }

        // レイヤがなければ追加
        if (!map.getLayer(HILLSHADE_LAYER_ID)) {
            // 文字ラベルの下、背景の上に挿入したいが、スタイルによって構造が違う。
            // 簡易的に最前面に追加し、ベクトルタイルの場合はIDを探して下に潜り込ませる工夫も可能だが、
            // ここではシンプルに最前面（ラベルの上）か、背景直後に追加する。
            // ベクトル地図の場合、ラベルが隠れないように制御するのは複雑なため、単純追加とする。
            map.addLayer({
                id: HILLSHADE_LAYER_ID,
                type: 'raster',
                source: HILLSHADE_SOURCE_ID,
                paint: {
                    'raster-opacity': opacity,
                    'raster-resampling': 'linear'
                }
            });
        } else {
            // 既に存在すればプロパティ更新
            map.setPaintProperty(HILLSHADE_LAYER_ID, 'raster-opacity', opacity);
        }
    }

    // UIイベントリスナー（陰影図）
    document.getElementById('hillshade-toggle').addEventListener('change', updateHillshade);
    document.getElementById('hillshade-opacity').addEventListener('input', updateHillshade);
    document.getElementById('hillshade-multiply').addEventListener('change', () => {
        // MapLibreは乗算(multiply)ブレンドモードをサポートしていないため、
        // 「乗算」がONのときは透過率を少し下げて「濃く」見せるなどのハックを行うか、そのままにする。
        // ここではユーザーへのフィードバックとしてコンソールログのみとし、不透明度はスライダーに従う。
        console.log("Note: Native 'multiply' blend mode is not supported for raster layers in MapLibre GL JS.");
        updateHillshade();
    });

    // --- 3D地形 (Terrain) の処理 ---
    const TERRAIN_SOURCE_ID = 'terrain-source';
    
    function updateTerrain() {
        const isChecked = document.getElementById('terrain-toggle').checked;
        const exaggeration = parseFloat(document.getElementById('terrain-exaggeration').value);

        document.getElementById('exaggeration-val').textContent = exaggeration.toFixed(1);

        if (!isChecked) {
            if (map.getTerrain()) {
                map.setTerrain(null);
            }
            // 不要になったソースを削除しても良いが、キャッシュとして残しても良い。
            // 地形をOFFにしたらピッチも戻すと親切
            map.easeTo({ pitch: 0 });
            return;
        }

        // ソース追加 (産総研 シームレス標高タイル PNG RGB)
        // MapLibreの地形にはRGBエンコードされたDEMが必要です。国土地理院純正のPNGは特殊形式のため直接使えません。
        if (!map.getSource(TERRAIN_SOURCE_ID)) {
            map.addSource(TERRAIN_SOURCE_ID, {
                type: 'raster-dem',
                tiles: [
                    'https://tiles.gsj.jp/tiles/elev/mixed/{z}/{y}/{x}.png'
                ],
                tileSize: 256,
                encoding: 'mapbox', // 産総研タイルはMapbox互換のRGB形式
                maxzoom: 17,
                attribution: '<a href="https://tiles.gsj.jp/tiles/elev/tiles.html" target="_blank">産総研</a>'
            });
        }

        // 地形有効化
        map.setTerrain({
            source: TERRAIN_SOURCE_ID,
            exaggeration: exaggeration
        });

        // 3D感を出すために少し傾ける
        if (map.getPitch() === 0) {
            map.easeTo({ pitch: 60, duration: 1000 });
        }
    }

    // UIイベントリスナー（地形）
    document.getElementById('terrain-toggle').addEventListener('change', updateTerrain);
    document.getElementById('terrain-exaggeration').addEventListener('input', updateTerrain);

    // --- パネル開閉ロジック ---
    const panel = document.getElementById('control-panel');
    const toggleBtn = document.getElementById('toggle-btn');
    const menuIcon = document.getElementById('menu-icon-placeholder');
    const panelContent = document.getElementById('panel-content');

    toggleBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // パネル自体のクリックイベントへの伝播を防ぐ
        panel.classList.toggle('collapsed');
        
        if (panel.classList.contains('collapsed')) {
            toggleBtn.textContent = ""; 
            menuIcon.style.display = 'block';
            toggleBtn.style.width = "100%";
            toggleBtn.style.height = "100%";
            toggleBtn.style.top = "0";
            toggleBtn.style.right = "0";
        } else {
            toggleBtn.textContent = "−";
            menuIcon.style.display = 'none';
            toggleBtn.style.width = "30px";
            toggleBtn.style.height = "30px";
            toggleBtn.style.top = "5px";
            toggleBtn.style.right = "5px";
        }
    });

    // 折りたたまれている時にパネルをクリックしたら開く
    panel.addEventListener('click', () => {
        if (panel.classList.contains('collapsed')) {
            panel.classList.remove('collapsed');
            toggleBtn.textContent = "−";
            menuIcon.style.display = 'none';
            toggleBtn.style.width = "30px";
            toggleBtn.style.height = "30px";
            toggleBtn.style.top = "5px";
            toggleBtn.style.right = "5px";
        }
    });

    // 初期ロード時のイベント登録
    map.on('load', () => {
        // 初期状態では地形等はOFF、必要ならここでONにする関数を呼ぶ
    });

</script>
</body>
</html>