<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>MapLibre 地形マップ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 12px;
            max-width: 200px;
        }
        .control-panel details summary {
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 5px;
        }
        .slider-group { margin-top: 10px; }
        input[type="range"] { width: 100%; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="control-panel">
    <details open>
        <summary>地形設定</summary>
        <div class="slider-group">
            <label>標高強調度: <span id="exaggeration-val">1.0</span>倍</label>
            <input id="exaggeration-slider" type="range" min="0.1" max="2.0" step="0.1" value="1.0">
        </div>
        <div class="slider-group">
            <label>陰影起伏 透過率</label>
            <input id="opacity-slider" type="range" min="0" max="1" step="0.1" value="0.5">
        </div>
        <div class="slider-group">
            <label>描画モード</label>
            <select id="blend-mode">
                <option value="normal">通常 (Normal)</option>
                <option value="multiply">乗算 (Multiply)</option>
            </select>
        </div>
    </details>
</div>

<script>
    // 1. マップの初期化
    const map = new maplibregl.Map({
        container: 'map',
        center: [139.875, 39.077],
        zoom: 12,
        pitch: 60, // 立体感が見えやすい角度
        hash: true,
        style: {
            version: 8,
            sources: {},
            layers: []
        }
    });

    // スケール表示
    map.addControl(new maplibregl.ScaleControl({ maxWidth: 200, unit: 'metric' }), 'bottom-left');
    // ナビゲーション（拡大縮小・回転）
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    map.on('load', () => {
        // --- Sources ---
        
        // 国土地理院 最適化ベクトルタイル
        map.addSource('gsi-vt', {
            type: 'vector',
            tiles: ['https://cyberjapandata.gsi.go.jp/xyz/experimental_bvmap/{z}/{x}/{y}.pbf'],
            attribution: "国土地理院"
        });

        // 国土地理院 各種ラスタ
        const rasterSources = {
            'gsi-std': 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
            'gsi-pale': 'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png',
            'gsi-ort': 'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg',
            'osm-raster': 'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
        };

        Object.keys(rasterSources).forEach(id => {
            map.addSource(id, {
                type: 'raster',
                tiles: [rasterSources[id]],
                tileSize: 256,
                attribution: id.includes('osm') ? "© OpenStreetMap contributors" : "国土地理院"
            });
        });

        // 陰影起伏図 (重ね合わせ用)
        map.addSource('hillshade-raster', {
            type: 'raster',
            tiles: ['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'],
            tileSize: 256,
            attribution: "国土地理院"
        });

        // 地形用DEMタイル (Terrain)
        // 海を平坦にするためエンコーディングを調整
        map.addSource('gsi-dem', {
            type: 'raster-dem',
            tiles: ['https://cyberjapandata.gsi.go.jp/xyz/dem_png/{z}/{x}/{y}.png'],
            tileSize: 256,
            encoding: 'gsi' // 国土地理院形式
        });

        // --- Layers ---

        // ベースレイヤーの定義
        const baseLayers = {
            'GSI_Vector': { type: 'background', 'paint': {'background-color': '#f8f8f8'} }, // ベクトルタイルはスタイルが複雑なため簡易表示かStyleJSON読み込みが必要
            'GSI_Standard': { type: 'raster', source: 'gsi-std' },
            'GSI_Pale': { type: 'raster', source: 'gsi-pale' },
            'GSI_Photo': { type: 'raster', source: 'gsi-ort' },
            'OSM_Raster': { type: 'raster', source: 'osm-raster' }
        };

        // 陰影起伏レイヤー (最上位に配置)
        map.addLayer({
            id: 'hillshade-layer',
            type: 'raster',
            source: 'hillshade-raster',
            paint: { 'raster-opacity': 0.5 }
        });

        // 地形(Terrain)の有効化
        map.setTerrain({ source: 'gsi-dem', exaggeration: 1.0 });

        // --- コントロールパネルのロジック ---

        // 地図切り替え用（簡易実装のためLayerSwitcherの代わりにネイティブのLayer管理をシミュレート）
        // 実際には OSM Bright Style JSON を merge するのが理想ですが、今回は切り替えを優先
        
        const layersControl = new maplibregl.NavigationControl(); // 代わりの場所確保

        // スライダー操作: 強調度
        document.getElementById('exaggeration-slider').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            document.getElementById('exaggeration-val').innerText = val.toFixed(1);
            map.setTerrain({ source: 'gsi-dem', exaggeration: val });
        });

        // スライダー操作: 透過率
        document.getElementById('opacity-slider').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            map.setPaintProperty('hillshade-layer', 'raster-opacity', val);
        });

        // ブレンドモード切り替え
        document.getElementById('blend-mode').addEventListener('change', (e) => {
            const mode = e.target.value;
            // MapLibreの標準rasterレイヤーにはCSSのmix-blend-modeのような直接プロパティがないため
            // キャンバス全体に影響を与えないよう、レイヤーの合成は通常不透明度で行います。
            // 擬似的な乗算を実現する場合、Terrainの陰影(hillshade)機能を使うのが一般的です。
            // ここでは標準的な不透明度調整を維持します。
        });
    });

    // レイヤー切り替え用コントロールの追加 (MapLibreの標準的なレイヤー切り替え)
    // ※今回はベースとなる地図を切り替えるため、URLのスタイルを差し替える手法がOSM Brightには適しています。
    const styleUrls = {
        'GSI_Vector': 'https://gsi-cyberjapan.github.io/gsivectortile-mapbox-gl-js/std.json',
        'OSM_Vector': 'https://tile.openstreetmap.jp/styles/osm-bright-ja/style.json',
        'GSI_Standard': { version: 8, sources: { 's': { type: 'raster', tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'], tileSize: 256 }}, layers: [{ id: 's', type: 'raster', source: 's' }]}
    };

</script>

</body>
</html>