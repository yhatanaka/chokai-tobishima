<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>国土地理院 & OSM 立体地形マップ</title>
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            max-width: 280px;
            z-index: 1;
        }
        
        .panel-header {
            padding: 10px;
            cursor: pointer;
            background: #f0f0f0;
            border-radius: 4px 4px 0 0;
            font-weight: bold;
            user-select: none;
        }
        
        .panel-content {
            padding: 10px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .panel-content.collapsed {
            display: none;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .radio-option {
            margin: 5px 0;
            font-size: 12px;
        }
        
        .slider-container {
            margin-top: 5px;
        }
        
        .slider-container input[type="range"] {
            width: 100%;
        }
        
        .slider-value {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }
        
        input[type="radio"] {
            margin-right: 5px;
        }
        
        .toggle-icon {
            float: right;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="control-panel">
        <div class="panel-header" onclick="togglePanel()">
            地図設定 <span class="toggle-icon" id="toggleIcon">▼</span>
        </div>
        <div class="panel-content" id="panelContent">
            <div class="control-group">
                <label>ベースマップ</label>
                <div class="radio-option">
                    <input type="radio" name="basemap" value="optimized" id="opt" checked>
                    <label for="opt">最適化ベクトルタイル</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="basemap" value="standard" id="std">
                    <label for="std">標準地図</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="basemap" value="pale" id="pale">
                    <label for="pale">淡色地図</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="basemap" value="photo" id="photo">
                    <label for="photo">写真地図</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="basemap" value="osm-raster" id="osmr">
                    <label for="osmr">OSM ラスタ</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="basemap" value="osm-vector" id="osmv">
                    <label for="osmv">OSM ベクタ</label>
                </div>
            </div>
            
            <div class="control-group">
                <label>陰影起伏図</label>
                <div class="radio-option">
                    <input type="checkbox" id="hillshade" onchange="toggleHillshade()">
                    <label for="hillshade">表示</label>
                </div>
                <div class="slider-container">
                    <label style="font-weight: normal;">透過率</label>
                    <input type="range" id="hillshadeOpacity" min="0" max="100" value="50" oninput="updateHillshadeOpacity()">
                    <div class="slider-value" id="opacityValue">50%</div>
                </div>
                <div class="radio-option" style="margin-top: 10px;">
                    <input type="radio" name="blendmode" value="normal" id="normal" checked>
                    <label for="normal">通常</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="blendmode" value="multiply" id="multiply">
                    <label for="multiply">乗算</label>
                </div>
            </div>
            
            <div class="control-group">
                <label>3D地形</label>
                <div class="radio-option">
                    <input type="checkbox" id="terrain" onchange="toggleTerrain()">
                    <label for="terrain">表示</label>
                </div>
                <div class="slider-container">
                    <label style="font-weight: normal;">標高強調</label>
                    <input type="range" id="exaggeration" min="0.1" max="2" step="0.1" value="1" oninput="updateExaggeration()">
                    <div class="slider-value" id="exaggerationValue">1.0倍</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'gsi-optimized': {
                        type: 'vector',
                        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/optimal_bvmap-v1/{z}/{x}/{y}.pbf'],
                        minzoom: 4,
                        maxzoom: 16,
                        attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>'
                    },
                    'gsi-standard': {
                        type: 'raster',
                        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>'
                    },
                    'gsi-pale': {
                        type: 'raster',
                        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>'
                    },
                    'gsi-photo': {
                        type: 'raster',
                        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],
                        tileSize: 256,
                        attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>'
                    },
                    'osm-raster': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    },
                    'gsi-hillshade': {
                        type: 'raster',
                        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>'
                    },
                    'gsi-dem': {
                        type: 'raster-dem',
                        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/dem_png/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>',
                        encoding: 'terrarium'
                    }
                },
                layers: [
                    {
                        id: 'background',
                        type: 'background',
                        paint: { 'background-color': '#f0f0f0' }
                    },
                    {
                        id: 'gsi-optimized-layer',
                        type: 'fill',
                        source: 'gsi-optimized',
                        'source-layer': 'landforma',
                        layout: { visibility: 'visible' },
                        paint: { 'fill-color': '#e0e0e0' }
                    },
                    {
                        id: 'gsi-standard-layer',
                        type: 'raster',
                        source: 'gsi-standard',
                        layout: { visibility: 'none' }
                    },
                    {
                        id: 'gsi-pale-layer',
                        type: 'raster',
                        source: 'gsi-pale',
                        layout: { visibility: 'none' }
                    },
                    {
                        id: 'gsi-photo-layer',
                        type: 'raster',
                        source: 'gsi-photo',
                        layout: { visibility: 'none' }
                    },
                    {
                        id: 'osm-raster-layer',
                        type: 'raster',
                        source: 'osm-raster',
                        layout: { visibility: 'none' }
                    },
                    {
                        id: 'gsi-hillshade-layer',
                        type: 'raster',
                        source: 'gsi-hillshade',
                        layout: { visibility: 'none' },
                        paint: {
                            'raster-opacity': 0.5
                        }
                    }
                ],
                glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf'
            },
            center: [139.875, 39.077],
            zoom: 8,
            pitch: 0
        });

        map.addControl(new maplibregl.NavigationControl());
        map.addControl(new maplibregl.ScaleControl({ unit: 'metric' }), 'bottom-left');

        let currentBasemap = 'optimized';
        let osmVectorLoaded = false;

        map.on('load', () => {
            document.querySelectorAll('input[name="basemap"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    switchBasemap(e.target.value);
                });
            });

            document.querySelectorAll('input[name="blendmode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    updateBlendMode(e.target.value);
                });
            });
        });

        function switchBasemap(basemap) {
            const layers = {
                'optimized': 'gsi-optimized-layer',
                'standard': 'gsi-standard-layer',
                'pale': 'gsi-pale-layer',
                'photo': 'gsi-photo-layer',
                'osm-raster': 'osm-raster-layer'
            };

            Object.values(layers).forEach(layer => {
                if (map.getLayer(layer)) {
                    map.setLayoutProperty(layer, 'visibility', 'none');
                }
            });

            if (basemap === 'osm-vector') {
                if (!osmVectorLoaded) {
                    loadOSMVector();
                    osmVectorLoaded = true;
                } else {
                    showOSMVector();
                }
            } else {
                hideOSMVector();
                if (layers[basemap] && map.getLayer(layers[basemap])) {
                    map.setLayoutProperty(layers[basemap], 'visibility', 'visible');
                }
            }
            
            currentBasemap = basemap;
        }

        function loadOSMVector() {
            fetch('https://tile.openstreetmap.jp/styles/osm-bright-ja/style.json')
                .then(res => res.json())
                .then(style => {
                    style.layers.forEach(layer => {
                        if (!map.getLayer(layer.id)) {
                            if (!map.getSource(layer.source)) {
                                const sourceData = style.sources[layer.source];
                                if (sourceData) {
                                    map.addSource(layer.source, sourceData);
                                }
                            }
                            map.addLayer(layer, 'gsi-hillshade-layer');
                        }
                    });
                })
                .catch(err => console.error('OSMベクタ読み込みエラー:', err));
        }

        function showOSMVector() {
            const styleLayers = map.getStyle().layers;
            styleLayers.forEach(layer => {
                if (layer.id.includes('osm') || layer.source === 'openmaptiles') {
                    map.setLayoutProperty(layer.id, 'visibility', 'visible');
                }
            });
        }

        function hideOSMVector() {
            const styleLayers = map.getStyle().layers;
            styleLayers.forEach(layer => {
                if (layer.id.includes('osm') || layer.source === 'openmaptiles') {
                    if (map.getLayer(layer.id)) {
                        map.setLayoutProperty(layer.id, 'visibility', 'none');
                    }
                }
            });
        }

        function toggleHillshade() {
            const visible = document.getElementById('hillshade').checked;
            map.setLayoutProperty('gsi-hillshade-layer', 'visibility', visible ? 'visible' : 'none');
        }

        function updateHillshadeOpacity() {
            const opacity = document.getElementById('hillshadeOpacity').value / 100;
            document.getElementById('opacityValue').textContent = Math.round(opacity * 100) + '%';
            map.setPaintProperty('gsi-hillshade-layer', 'raster-opacity', opacity);
        }

        function updateBlendMode(mode) {
            const paintMode = mode === 'multiply' ? 'multiply' : 'normal';
            map.setPaintProperty('gsi-hillshade-layer', 'raster-opacity-transition', { duration: 0 });
            
            if (map.getLayer('gsi-hillshade-layer')) {
                map.removeLayer('gsi-hillshade-layer');
                map.addLayer({
                    id: 'gsi-hillshade-layer',
                    type: 'raster',
                    source: 'gsi-hillshade',
                    layout: { 
                        visibility: document.getElementById('hillshade').checked ? 'visible' : 'none'
                    },
                    paint: {
                        'raster-opacity': document.getElementById('hillshadeOpacity').value / 100,
                        'raster-blend-mode': paintMode
                    }
                });
            }
        }

        function toggleTerrain() {
            const enabled = document.getElementById('terrain').checked;
            if (enabled) {
                map.setTerrain({
                    source: 'gsi-dem',
                    exaggeration: parseFloat(document.getElementById('exaggeration').value)
                });
                map.setPitch(60);
            } else {
                map.setTerrain(null);
                map.setPitch(0);
            }
        }

        function updateExaggeration() {
            const value = parseFloat(document.getElementById('exaggeration').value);
            document.getElementById('exaggerationValue').textContent = value.toFixed(1) + '倍';
            if (document.getElementById('terrain').checked) {
                map.setTerrain({
                    source: 'gsi-dem',
                    exaggeration: value
                });
            }
        }

        function togglePanel() {
            const content = document.getElementById('panelContent');
            const icon = document.getElementById('toggleIcon');
            content.classList.toggle('collapsed');
            icon.textContent = content.classList.contains('collapsed') ? '▶' : '▼';
        }
    </script>
</body>
</html>