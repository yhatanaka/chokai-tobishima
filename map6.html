<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高機能地図ビューア (MapLibre + GSI + OSM)</title>
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* コントロールパネルのスタイル */
        #control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            width: 280px;
            max-height: 90vh;
            overflow-y: auto;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        #control-panel.collapsed {
            width: 40px;
            height: 40px;
            padding: 0;
            overflow: hidden;
            background: #fff;
        }

        /* 折りたたみボタン */
        #toggle-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 30px;
            height: 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            z-index: 20;
        }
        #control-panel.collapsed #toggle-btn {
            top: 5px;
            left: 5px;
            width: 100%;
            height: 100%;
        }

        .panel-content {
            margin-top: 25px;
        }
        #control-panel.collapsed .panel-content {
            display: none;
        }

        h3 { margin: 0 0 10px 0; font-size: 16px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; cursor: pointer; }
        .group { margin-bottom: 15px; border-bottom: 1px dotted #eee; padding-bottom: 10px; }
        .slider-container { display: flex; align-items: center; justify-content: space-between; font-size: 12px; }
        input[type="range"] { width: 60%; }
        select { width: 100%; padding: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="control-panel">
    <button id="toggle-btn" title="パネル切り替え">⚙️</button>
    <div class="panel-content">
        <h3>地図切り替え</h3>
        <div class="group">
            <select id="basemap-select">
                <option value="gsi-opt-vector" selected>地理院 最適化ベクトル</option>
                <option value="gsi-std">地理院 標準地図</option>
                <option value="gsi-pale">地理院 淡色地図</option>
                <option value="gsi-photo">地理院 写真</option>
                <option value="osm-raster">OpenStreetMap (Raster)</option>
                <option value="osm-vector">OpenStreetMap (Vector)</option>
            </select>
        </div>

        <h3>地形・標高 (3D)</h3>
        <div class="group">
            <label>
                <input type="checkbox" id="terrain-toggle" checked> 地形有効化 (3D)
            </label>
            <div class="slider-container">
                <span>高さ倍率: <span id="exaggeration-val">1.0</span>x</span>
                <input type="range" id="exaggeration-slider" min="0.1" max="2.0" step="0.1" value="1.0">
            </div>
        </div>

        <h3>陰影起伏図レイヤ</h3>
        <div class="group">
            <label>
                <input type="checkbox" id="hillshade-toggle" checked> 表示する
            </label>
            <div class="slider-container">
                <span>不透明度: <span id="opacity-val">0.7</span></span>
                <input type="range" id="opacity-slider" min="0" max="1" step="0.1" value="0.7">
            </div>
            <div style="margin-top:8px;">
                <label style="font-size:12px;">
                    <input type="radio" name="hs-mode" value="normal"> 通常 (画像重ね合わせ)
                </label>
                <label style="font-size:12px;">
                    <input type="radio" name="hs-mode" value="multiply" checked> 乗算風 (計算陰影)
                </label>
                <p style="font-size:10px; color:#666; margin-top:2px;">
                    ※乗算風はDEMデータから動的に影を生成し、下の地図の色味を活かします。
                </p>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>

<script>
    // ---------------------------------------------------------
    // 1. GSI DEM (PNG) -> Mapbox RGB 変換プロトコル
    // 国土地理院の標高タイルをMapLibreで使える形式に変換します
    // ---------------------------------------------------------
    maplibregl.addProtocol('gsi-terrain', (params, callback) => {
        const image = new Image();
        image.crossOrigin = "anonymous";
        
        image.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = image.width;
            canvas.height = image.height;
            const context = canvas.getContext('2d');
            context.drawImage(image, 0, 0);
            
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // GSI形式: x = 2^16R + 2^8G + B
                // u = 0.01 (分解能)
                // h = (x < 2^23) ? x * u : (x - 2^24) * u
                // 無効値(e)への対応は簡易的に0扱いまたは補間
                
                let x = (r << 16) + (g << 8) + b;
                let h = (x < 8388608) ? x * 0.01 : (x - 16777216) * 0.01;
                
                // Mapbox RGB形式へのエンコード
                // h = -10000 + ((R * 256 * 256 + G * 256 + B) * 0.1)
                // => (h + 10000) * 10 = R_m*2^16 + G_m*2^8 + B_m
                
                const mboxH = (h + 10000.0) * 10.0;
                const mboxInt = Math.floor(mboxH);
                
                data[i] = (mboxInt >> 16) & 255;
                data[i + 1] = (mboxInt >> 8) & 255;
                data[i + 2] = mboxInt & 255;
                data[i + 3] = 255; // Alpha
            }
            
            context.putImageData(imageData, 0, 0);
            canvas.toBlob((blob) => {
                callback(null, blob, null, null);
            }, 'image/png');
        };
        
        image.onerror = () => {
            callback(new Error("Tile load error"));
        };
        
        // URLのプロトコル部分を置換して実際のURLへ
        const url = params.url.replace('gsi-terrain://', 'https://cyberjapandata.gsi.go.jp/xyz/dem_png/');
        image.src = url;
        
        return { cancel: () => {} };
    });

    // ---------------------------------------------------------
    // 2. 地図設定と定義
    // ---------------------------------------------------------
    
    // ベースマップ定義
    const baseMaps = {
        'gsi-opt-vector': {
            type: 'style',
            url: 'https://gsi-cyberjapan.github.io/optimal_bvmap/style/std.json'
        },
        'gsi-std': {
            type: 'raster',
            tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],
            attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>国土地理院</a>"
        },
        'gsi-pale': {
            type: 'raster',
            tiles: ['https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png'],
            attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>国土地理院</a>"
        },
        'gsi-photo': {
            type: 'raster',
            tiles: ['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],
            attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>国土地理院</a>"
        },
        'osm-raster': {
            type: 'raster',
            tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        },
        'osm-vector': {
            type: 'style',
            url: 'https://tile.openstreetmap.jp/styles/maptiler-basic-ja/style.json'
        }
    };

    // マップ初期化
    const map = new maplibregl.Map({
        container: 'map',
        style: baseMaps['gsi-opt-vector'].url, // 初期表示
        center: [139.875, 39.077],
        zoom: 10,
        pitch: 0,
        bearing: 0,
        hash: true
    });

    // コントロール追加
    map.addControl(new maplibregl.NavigationControl(), 'top-right');
    map.addControl(new maplibregl.ScaleControl({ maxWidth: 200, unit: 'metric' }), 'bottom-left');

    // ---------------------------------------------------------
    // 3. レイヤ管理ロジック
    // ---------------------------------------------------------

    // 共通ソース（DEMと陰影起伏図）を追加する関数
    function addCommonSourcesAndLayers() {
        // 1. DEMソース (カスタムプロトコル使用)
        if (!map.getSource('gsi-dem')) {
            map.addSource('gsi-dem', {
                type: 'raster-dem',
                tiles: [
                    'gsi-terrain://{z}/{x}/{y}.png'
                ],
                tileSize: 256,
                maxzoom: 14,
                attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>国土地理院(DEM)</a>"
            });
        }

        // 2. 地形有効化
        updateTerrain();

        // 3. 陰影起伏図 (ラスタ画像) ソース
        if (!map.getSource('gsi-hillshade-raster')) {
            map.addSource('gsi-hillshade-raster', {
                type: 'raster',
                tiles: ['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>国土地理院(陰影)</a>"
            });
        }

        updateHillshadeLayer();
    }

    // 地形の更新
    function updateTerrain() {
        const isEnabled = document.getElementById('terrain-toggle').checked;
        const exaggeration = parseFloat(document.getElementById('exaggeration-slider').value);
        
        if (isEnabled) {
            map.setTerrain({ source: 'gsi-dem', exaggeration: exaggeration });
        } else {
            map.setTerrain(null);
        }
    }

    // 陰影レイヤの更新 (Normal vs Multiply)
    function updateHillshadeLayer() {
        // 既存レイヤがあれば削除
        if (map.getLayer('overlay-hillshade-raster')) map.removeLayer('overlay-hillshade-raster');
        if (map.getLayer('overlay-hillshade-computed')) map.removeLayer('overlay-hillshade-computed');

        const isShown = document.getElementById('hillshade-toggle').checked;
        if (!isShown) return;

        const mode = document.querySelector('input[name="hs-mode"]:checked').value;
        const opacity = parseFloat(document.getElementById('opacity-slider').value);

        if (mode === 'normal') {
            // 通常モード: 国土地理院の陰影起伏図画像を重ねる
            map.addLayer({
                id: 'overlay-hillshade-raster',
                type: 'raster',
                source: 'gsi-hillshade-raster',
                paint: {
                    'raster-opacity': opacity
                }
            });
        } else {
            // 乗算風モード: DEMデータからMapLibre上で陰影を計算する
            // これにより、下の地図の色を保持したまま陰影がつきます（実質的な乗算効果）
            map.addLayer({
                id: 'overlay-hillshade-computed',
                type: 'hillshade',
                source: 'gsi-dem', // DEMソースを使用
                paint: {
                    'hillshade-exaggeration': 0.8, // 陰影の強さ
                    'hillshade-shadow-color': '#000000',
                    'hillshade-highlight-color': '#FFFFFF',
                    'hillshade-accent-color': '#000000',
                    'hillshade-illumination-direction': 315,
                    'hillshade-illumination-anchor': 'viewport'
                },
                layout: { visibility: 'visible' }
            });
            // Computed Hillshade自体の透明度は直接操作しにくいが、
            // hillshade-exaggeration や shadow-color のアルファ値で調整可能。
            // ここでは簡易的に全体のOpacityを再現するため、shadow-colorの透明度で近似するか、
            // もしくはレイヤ自体のopacityプロパティがないため、exaggerationで代用感を出す。
            // MapLibreのhillshadeレイヤには raster-opacity のような全透過プロパティがないため
            // 完全にスライダーと連動させるのは難しいが、exaggerationを変更して対応する。
            map.setPaintProperty('overlay-hillshade-computed', 'hillshade-exaggeration', opacity);
        }
    }

    // スタイルロード完了時の処理 (初期ロードおよびベースマップ切り替え時)
    map.on('style.load', () => {
        addCommonSourcesAndLayers();
    });

    // ---------------------------------------------------------
    // 4. UIイベントリスナー
    // ---------------------------------------------------------

    // ベースマップ切り替え
    document.getElementById('basemap-select').addEventListener('change', (e) => {
        const key = e.target.value;
        const config = baseMaps[key];

        if (config.type === 'style') {
            map.setStyle(config.url);
        } else {
            // ラスタの場合は空のスタイルを作ってレイヤを追加
            map.setStyle({
                version: 8,
                sources: {
                    'raster-source': {
                        type: 'raster',
                        tiles: config.tiles,
                        tileSize: 256,
                        attribution: config.attribution
                    }
                },
                layers: [
                    {
                        id: 'raster-layer',
                        type: 'raster',
                        source: 'raster-source',
                        minzoom: 0,
                        maxzoom: 22
                    }
                ],
                glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf" // フォントエラー回避用ダミー
            });
        }
        // setStyleされるとソース・レイヤがリセットされるため、
        // 'style.load' イベントリスナーが発火して再設定関数が呼ばれます。
    });

    // パネル開閉
    const panel = document.getElementById('control-panel');
    const toggleBtn = document.getElementById('toggle-btn');
    toggleBtn.addEventListener('click', () => {
        panel.classList.toggle('collapsed');
        toggleBtn.textContent = panel.classList.contains('collapsed') ? '⚙️' : '✖';
    });

    // 地形 (3D) スイッチ
    document.getElementById('terrain-toggle').addEventListener('change', updateTerrain);

    // 地形強調スライダー
    document.getElementById('exaggeration-slider').addEventListener('input', (e) => {
        document.getElementById('exaggeration-val').textContent = e.target.value;
        updateTerrain();
    });

    // 陰影レイヤ 表示スイッチ
    document.getElementById('hillshade-toggle').addEventListener('change', updateHillshadeLayer);

    // 陰影 透明度スライダー
    document.getElementById('opacity-slider').addEventListener('input', (e) => {
        const val = e.target.value;
        document.getElementById('opacity-val').textContent = val;
        
        // モードに応じてプロパティ更新
        if (map.getLayer('overlay-hillshade-raster')) {
            map.setPaintProperty('overlay-hillshade-raster', 'raster-opacity', parseFloat(val));
        }
        if (map.getLayer('overlay-hillshade-computed')) {
            // hillshadeレイヤにはopacityがないのでexaggerationで代用
            map.setPaintProperty('overlay-hillshade-computed', 'hillshade-exaggeration', parseFloat(val));
        }
    });

    // 陰影モード切り替え (通常 vs 乗算)
    document.querySelectorAll('input[name="hs-mode"]').forEach(radio => {
        radio.addEventListener('change', updateHillshadeLayer);
    });

</script>
</body>
</html>