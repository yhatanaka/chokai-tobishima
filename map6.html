<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSI & OSM Map Viewer (MapLibre)</title>
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* コントロールパネルのスタイル */
        #control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            max-width: 300px;
            z-index: 100;
            font-size: 14px;
        }
        
        details > summary {
            cursor: pointer;
            font-weight: bold;
            outline: none;
            margin-bottom: 5px;
        }
        
        .control-group {
            margin-bottom: 12px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        label {
            display: block;
            margin-top: 5px;
        }
        
        select, input[type="range"] {
            width: 100%;
            margin-top: 3px;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        .checkbox-row input {
            width: auto;
            margin-right: 8px;
        }
        
        .value-display {
            float: right;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div id="control-panel">
    <details open>
        <summary>地図設定 / Settings</summary>
        
        <div class="control-group">
            <strong>ベースマップ</strong>
            <select id="basemap-select">
                <option value="gsi_opt_vector">地理院 最適化ベクトル</option>
                <option value="gsi_std">地理院 標準地図</option>
                <option value="gsi_pale">地理院 淡色地図</option>
                <option value="gsi_photo">地理院 写真</option>
                <option value="osm_vector">OSM Vector (MapTiler)</option>
                <option value="osm_raster">OSM Raster</option>
            </select>
        </div>

        <div class="control-group">
            <strong>陰影起伏図 (重ね合わせ)</strong>
            <div class="checkbox-row">
                <input type="checkbox" id="hillshade-visible">
                <label for="hillshade-visible" style="margin-top:0">表示する</label>
            </div>
            
            <label>
                不透明度: <span id="hillshade-opacity-val" class="value-display">0.7</span>
                <input type="range" id="hillshade-opacity" min="0" max="1" step="0.1" value="0.7">
            </label>
            
            <div class="checkbox-row">
                <input type="checkbox" id="hillshade-blend">
                <label for="hillshade-blend" style="margin-top:0">乗算モード (擬似)</label>
            </div>
            <small style="color:#666; font-size:11px;">※白を透過し影のみ強調します</small>
        </div>

        <div class="control-group">
            <strong>3D 地形 (地理院DEM)</strong>
            <div class="checkbox-row">
                <input type="checkbox" id="terrain-toggle">
                <label for="terrain-toggle" style="margin-top:0">立体化を有効にする</label>
            </div>
            
            <label>
                高さ強調: <span id="terrain-exagg-val" class="value-display">1.0</span>倍
                <input type="range" id="terrain-exagg" min="0.1" max="2.0" step="0.1" value="1.0" disabled>
            </label>
        </div>
    </details>
</div>

<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/maplibre-gl-gsi-terrain/dist/maplibre-gl-gsi-terrain.js"></script>

<script>
    // --- 定数・設定 ---
    const INITIAL_CENTER = [139.875, 39.077]; // 指定の中心点
    const INITIAL_ZOOM = 12;

    // 地図スタイルの定義
    const STYLES = {
        // 地理院 最適化ベクトルタイル (GitHub提供のスタイル)
        gsi_opt_vector: 'https://gsi-cyberjapan.github.io/optimal_bvmap/style/std.json',
        
        // OSM Vector (MapTiler Basic JA - 指定のスタイル)
        osm_vector: 'https://tile.openstreetmap.jp/styles/maptiler-basic-ja/style.json',

        // 以下はラスタタイルのため、動的にスタイルオブジェクトを生成します
        gsi_std: {
            version: 8,
            sources: {
                'raster-tiles': {
                    type: 'raster',
                    tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],
                    tileSize: 256,
                    attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>国土地理院</a>"
                }
            },
            layers: [{ id: 'simple-raster', type: 'raster', source: 'raster-tiles' }]
        },
        gsi_pale: {
            version: 8,
            sources: {
                'raster-tiles': {
                    type: 'raster',
                    tiles: ['https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png'],
                    tileSize: 256,
                    attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>国土地理院</a>"
                }
            },
            layers: [{ id: 'simple-raster', type: 'raster', source: 'raster-tiles' }]
        },
        gsi_photo: {
            version: 8,
            sources: {
                'raster-tiles': {
                    type: 'raster',
                    tiles: ['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],
                    tileSize: 256,
                    attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>国土地理院</a>"
                }
            },
            layers: [{ id: 'simple-raster', type: 'raster', source: 'raster-tiles' }]
        },
        osm_raster: {
            version: 8,
            sources: {
                'raster-tiles': {
                    type: 'raster',
                    tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                    tileSize: 256,
                    attribution: "&copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors"
                }
            },
            layers: [{ id: 'simple-raster', type: 'raster', source: 'raster-tiles' }]
        }
    };

    // --- マップ初期化 ---
    const map = new maplibregl.Map({
        container: 'map',
        style: STYLES.gsi_opt_vector, // 初期表示: 最適化ベクトルタイル
        center: INITIAL_CENTER,
        zoom: INITIAL_ZOOM,
        hash: true,
        attributionControl: true
    });

    // スケールコントロール（左下）
    map.addControl(new maplibregl.ScaleControl({
        maxWidth: 200,
        unit: 'metric'
    }), 'bottom-left');

    // ナビゲーションコントロール
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    // --- UI要素の取得 ---
    const ui = {
        basemap: document.getElementById('basemap-select'),
        hillshadeVisible: document.getElementById('hillshade-visible'),
        hillshadeOpacity: document.getElementById('hillshade-opacity'),
        hillshadeBlend: document.getElementById('hillshade-blend'),
        terrainToggle: document.getElementById('terrain-toggle'),
        terrainExagg: document.getElementById('terrain-exaggeration'),
        // 表示用span
        hillshadeOpacityVal: document.getElementById('hillshade-opacity-val'),
        terrainExaggVal: document.getElementById('terrain-exagg-val')
    };

    // --- 機能実装 ---

    // 1. 陰影起伏図の追加・更新ロジック
    // スタイルが切り替わるたびにレイヤが消えるため、追加し直す関数
    function updateHillshadeLayer() {
        const sourceId = 'gsi-hillshade-source';
        const layerId = 'gsi-hillshade-layer';
        const isVisible = ui.hillshadeVisible.checked;
        const opacity = parseFloat(ui.hillshadeOpacity.value);
        const isBlend = ui.hillshadeBlend.checked;

        // UI値更新
        ui.hillshadeOpacityVal.textContent = opacity;

        // すでにソースがなければ追加
        if (!map.getSource(sourceId)) {
            map.addSource(sourceId, {
                type: 'raster',
                tiles: ['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>国土地理院(陰影起伏図)</a>"
            });
        }

        // レイヤの管理
        if (isVisible) {
            // レイヤがなければ追加
            if (!map.getLayer(layerId)) {
                // ラベルやPOIの下、背景地図の上に挿入したいが、簡単のため最上位または適切な位置に追加
                // Vectorタイルの場合、文字の下に入れるのが理想ですが、簡易的に最上位に追加します。
                map.addLayer({
                    id: layerId,
                    type: 'raster',
                    source: sourceId,
                    paint: {
                        'raster-opacity': opacity,
                        'raster-fade-duration': 0
                    }
                });
            } else {
                // プロパティ更新
                map.setPaintProperty(layerId, 'raster-opacity', opacity);
            }

            // 乗算(Multiply)モードの擬似再現
            // MapLibreのラスタレイヤには mix-blend-mode がないため、
            // コントラストを上げて白を飛ばし、暗い部分だけを残すような処理をします。
            if (isBlend) {
                // コントラストを上げ、明るい部分(白)の透明度を下げるハックは難しいので
                // ここでは「陰影の濃さを強調」する設定にします
                map.setPaintProperty(layerId, 'raster-contrast', 0.5); // 0が標準、上げるとコントラストが下がる実装もあるが調整が必要
                // 実際には標準機能で完全な乗算はできないため、少し暗くして馴染ませます
                // 標準: contrast 0, brightness-min 0, brightness-max 1
                // 擬似乗算: 少し暗く見せる
                map.setPaintProperty(layerId, 'raster-brightness-min', 0); 
                map.setPaintProperty(layerId, 'raster-brightness-max', 0.6); // 白をグレーにして乗算っぽく見せる
            } else {
                // 通常モード
                map.setPaintProperty(layerId, 'raster-contrast', 0);
                map.setPaintProperty(layerId, 'raster-brightness-min', 0);
                map.setPaintProperty(layerId, 'raster-brightness-max', 1);
            }

        } else {
            if (map.getLayer(layerId)) {
                map.removeLayer(layerId);
            }
        }
    }

    // 2. 地形 (DEM) の設定
    // maplibre-gl-gsi-terrain を使用してプロトコルを追加済み
    // gsi-terrain://... でアクセス可能
    function updateTerrain() {
        const isEnabled = ui.terrainToggle.checked;
        const exaggeration = parseFloat(ui.terrainExagg.value);

        ui.terrainExagg.disabled = !isEnabled;
        ui.terrainExaggVal.textContent = exaggeration;

        if (isEnabled) {
            // ソースがなければ追加
            if (!map.getSource('gsi-terrain-source')) {
                map.addSource('gsi-terrain-source', {
                    type: 'raster-dem',
                    // maplibre-gl-gsi-terrain が提供するプロトコルを使用
                    tiles: [
                        'gsi-terrain://https://cyberjapandata.gsi.go.jp/xyz/dem_png/{z}/{x}/{y}.png'
                    ],
                    tileSize: 256,
                    attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>国土地理院(標高)</a>"
                });
            }
            
            // 地形をセット
            map.setTerrain({
                source: 'gsi-terrain-source',
                exaggeration: exaggeration
            });
        } else {
            map.setTerrain(null);
        }
    }

    // --- イベントリスナー ---

    // スタイル変更時の処理
    ui.basemap.addEventListener('change', (e) => {
        const styleKey = e.target.value;
        const styleData = STYLES[styleKey];
        map.setStyle(styleData);
    });

    // スタイル読み込み完了時に、上乗せレイヤ(陰影・地形)を再適用する
    map.on('style.load', () => {
        updateHillshadeLayer();
        // 地形はソースが消えるため、再追加のロジックが必要
        // setStyleを呼ぶとSourceもクリアされるため、updateTerrain内で再追加が必要
        // ただし、即座に呼ぶとエラーになることがあるため少し待つか、ソースの存在確認を行う
        updateTerrain(); 
    });

    // 陰影起伏図のコントロール
    ui.hillshadeVisible.addEventListener('change', updateHillshadeLayer);
    ui.hillshadeOpacity.addEventListener('input', updateHillshadeLayer);
    ui.hillshadeBlend.addEventListener('change', updateHillshadeLayer);

    // 地形(3D)のコントロール
    ui.terrainToggle.addEventListener('change', updateTerrain);
    ui.terrainExagg.addEventListener('input', () => {
        ui.terrainExaggVal.textContent = ui.terrainExagg.value;
        if(map.getTerrain()) {
            map.setTerrain({
                source: 'gsi-terrain-source',
                exaggeration: parseFloat(ui.terrainExagg.value)
            });
        }
    });

    // 初回ロード時も実行
    map.on('load', () => {
        updateHillshadeLayer();
        // 初期状態では地形はOFF
    });

</script>
</body>
</html>